const f="https://leximix.de/api",m=`${f}/save.php`,p=`${f}/load.php`;let r=[],l=!1;const v=()=>{try{const e=localStorage.getItem("leximix_offline_queue");e&&(r=JSON.parse(e))}catch(e){console.error("[CloudStorage] Failed to load offline queue:",e),r=[]}},g=()=>{try{localStorage.setItem("leximix_offline_queue",JSON.stringify(r))}catch(e){console.error("[CloudStorage] Failed to save offline queue:",e)}},u=e=>e.replace(/\s+/g,"").toLowerCase();let a=0;const d=async(e,o)=>{const s=u(e),t=Date.now(),S={username:s,data:{...o,lastSaved:t},version:a,timestamp:t};try{const n=await fetch(m,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(S)}),i=await n.json();if(n.ok&&i.success)return a=i.version||a+1,console.log("[CloudStorage] IONOS save successful, version:",a),{success:!0,version:a};if(n.status===409)return console.warn("[CloudStorage] Conflict detected:",i),{success:!1,error:"conflict",version:i.serverVersion};throw new Error(i.error||"IONOS save failed")}catch(n){return console.error("[CloudStorage] Save failed:",n.message),navigator.onLine?{success:!1,error:n.message}:(O(s,o,t),{success:!0,error:"queued"})}},h=async e=>{const o=u(e);try{const t=await(await fetch(`${p}?username=${encodeURIComponent(o)}`,{method:"GET",headers:{"Content-Type":"application/json"}})).json();return t.success&&t.exists&&t.data?(a=t.version||0,console.log("[CloudStorage] IONOS load successful"),{success:!0,data:t.data,source:"ionos"}):{success:!0,data:null,source:"ionos"}}catch(s){return console.error("[CloudStorage] Load failed:",s),{success:!1,data:null,error:s.message}}},O=(e,o,s)=>{r=r.filter(t=>t.username!==e),r.push({username:e,data:o,timestamp:s,retries:0}),g(),console.log("[CloudStorage] Added to offline queue")},c=async()=>{if(l||r.length===0||!navigator.onLine)return;l=!0,console.log("[CloudStorage] Processing offline queue:",r.length,"items");const e=[...r];r=[];for(const o of e)try{const s=await d(o.username,o.data);!s.success&&s.error!=="conflict"&&o.retries<3&&r.push({...o,retries:o.retries+1})}catch(s){console.error("[CloudStorage] Queue item failed:",s),o.retries<3&&r.push({...o,retries:o.retries+1})}g(),l=!1},y=async(e,o)=>(await d(e,o)).success,C=()=>{v(),window.addEventListener("online",()=>{console.log("[CloudStorage] Back online - processing queue"),c()}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&c()}),navigator.onLine&&c()};typeof window<"u"&&C();const w={saveUserData:d,loadUserData:h,forceSync:y,processOfflineQueue:c,normalizeUsername:u};export{w as default,y as forceSync,C as initCloudStorage,h as loadUserData,u as normalizeUsername,c as processOfflineQueue,d as saveUserData};
