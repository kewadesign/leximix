const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-B1MovBq6.js","./index-BG55jUKZ.css"])))=>i.map(i=>d[i]);
import{_ as S}from"./index-B1MovBq6.js";const p="https://leximix.de/api",O=`${p}/save.php`,w=`${p}/load.php`;let n=[],f=!1;const C=()=>{try{const r=localStorage.getItem("leximix_offline_queue");r&&(n=JSON.parse(r))}catch(r){console.error("[CloudStorage] Failed to load offline queue:",r),n=[]}},v=()=>{try{localStorage.setItem("leximix_offline_queue",JSON.stringify(n))}catch(r){console.error("[CloudStorage] Failed to save offline queue:",r)}},g=r=>r.replace(/\s+/g,"").toLowerCase();let l=0;const d=async(r,e)=>{const o=g(r),t=Date.now(),a={username:o,data:{...e,lastSaved:t},version:l,timestamp:t};try{const i=await fetch(O,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),s=await i.json();if(i.ok&&s.success)return l=s.version||l+1,console.log("[CloudStorage] IONOS save successful, version:",l),m(o,e).catch(c=>console.warn("[CloudStorage] Firebase backup failed:",c)),{success:!0,version:l};if(i.status===409)return console.warn("[CloudStorage] Conflict detected:",s),{success:!1,error:"conflict",version:s.serverVersion};throw new Error(s.error||"IONOS save failed")}catch(i){console.warn("[CloudStorage] IONOS failed, trying Firebase:",i.message);try{if(await m(o,e))return{success:!0}}catch(s){console.error("[CloudStorage] Firebase fallback also failed:",s)}return navigator.onLine?{success:!1,error:i.message}:(b(o,e,t),{success:!0,error:"queued"})}},h=async r=>{const e=g(r);let o=null,t=0,a=null,i=0;try{const c=await(await fetch(`${w}?username=${encodeURIComponent(e)}`,{method:"GET",headers:{"Content-Type":"application/json"}})).json();c.success&&c.exists&&c.data&&(o=c.data,t=c.timestamp||c.data.lastSaved||0,l=c.version||0,console.log("[CloudStorage] IONOS load successful, timestamp:",t))}catch(s){console.warn("[CloudStorage] IONOS load failed:",s)}try{a=await y(e),a&&(i=a.lastSaved||0,console.log("[CloudStorage] Firebase load successful, timestamp:",i))}catch(s){console.warn("[CloudStorage] Firebase load failed:",s)}return o&&a?t>=i?(console.log("[CloudStorage] Using IONOS data (newer or equal)"),{success:!0,data:o,source:"ionos"}):(console.log("[CloudStorage] Using Firebase data (newer)"),d(e,a).catch(s=>console.warn("[CloudStorage] Failed to sync Firebase to IONOS:",s)),{success:!0,data:a,source:"firebase"}):o?{success:!0,data:o,source:"ionos"}:a?{success:!0,data:a,source:"firebase"}:{success:!0,data:null}},m=async(r,e)=>{try{const{saveToCloud:o}=await S(async()=>{const{saveToCloud:t}=await import("./index-B1MovBq6.js").then(a=>a.f);return{saveToCloud:t}},__vite__mapDeps([0,1]),import.meta.url);return await o(r,e)}catch(o){return console.error("[CloudStorage] Firebase backup save error:",o),!1}},y=async r=>{try{const{loadFromCloud:e}=await S(async()=>{const{loadFromCloud:o}=await import("./index-B1MovBq6.js").then(t=>t.f);return{loadFromCloud:o}},__vite__mapDeps([0,1]),import.meta.url);return await e(r)}catch(e){return console.error("[CloudStorage] Firebase backup load error:",e),null}},b=(r,e,o)=>{n=n.filter(t=>t.username!==r),n.push({username:r,data:e,timestamp:o,retries:0}),v(),console.log("[CloudStorage] Added to offline queue")},u=async()=>{if(f||n.length===0||!navigator.onLine)return;f=!0,console.log("[CloudStorage] Processing offline queue:",n.length,"items");const r=[...n];n=[];for(const e of r)try{const o=await d(e.username,e.data);!o.success&&o.error!=="conflict"&&e.retries<3&&n.push({...e,retries:e.retries+1})}catch(o){console.error("[CloudStorage] Queue item failed:",o),e.retries<3&&n.push({...e,retries:e.retries+1})}v(),f=!1},_=async(r,e)=>(await d(r,e)).success,F=()=>{C(),window.addEventListener("online",()=>{console.log("[CloudStorage] Back online - processing queue"),u()}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&u()}),navigator.onLine&&u()};typeof window<"u"&&F();const N={saveUserData:d,loadUserData:h,forceSync:_,processOfflineQueue:u,normalizeUsername:g};export{N as default,_ as forceSync,F as initCloudStorage,h as loadUserData,g as normalizeUsername,u as processOfflineQueue,d as saveUserData};
